trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildAngular
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: 20.x

          - task: Npm@1
            inputs:
              command: install

          - task: Npm@1
            inputs:
              command: custom
              customCommand: run build -- --configuration production --base-href=/secure-admin/

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: $(Build.SourcesDirectory)/dist
              artifactName: frontend

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - download: current
            artifact: frontend

          - task: PowerShell@2
            displayName: Deploy Files
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/frontend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\TRADERVPS\Sites\khulafx.com\secure-admin"
                
                Write-Host "Source: $src" -ForegroundColor Cyan
                Write-Host "Destination: $dst" -ForegroundColor Cyan
                
                if (-not (Test-Path $src)) {
                  Write-Error "Source not found"
                  exit 1
                }
                
                if (-not (Test-Path $dst)) {
                  Write-Error "Destination not accessible"
                  exit 1
                }
                
                $items = Get-ChildItem -Path $dst -Force -ErrorAction Continue
                foreach ($item in $items) {
                  Remove-Item -Path $item.FullName -Recurse -Force -ErrorAction SilentlyContinue
                }
                
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  if ($_.PSIsContainer) {
                    Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force
                  } else {
                    Copy-Item -Path $_.FullName -Destination $dst -Force
                  }
                  Write-Host "Copied: $($_.Name)" -ForegroundColor Green
                }
                
                $deployed = Get-ChildItem -Path $dst -Recurse -File
                Write-Host "Files deployed: $($deployed.Count)" -ForegroundColor Cyan
                
                $indexExists = Test-Path "$dst\index.html"
                if ($indexExists) {
                  Write-Host "index.html: FOUND" -ForegroundColor Green
                } else {
                  Write-Error "index.html NOT found"
                  exit 1
                }
