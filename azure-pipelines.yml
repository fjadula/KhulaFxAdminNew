# Azure Pipeline for KhulaFxAdminNew (Frontend Angular)
# Uses variables from 'Deployment-Secrets' group
# Base Href: /secure-admin/

trigger:
  branches:
    include:
      - main
      - master

pool:
  name: 'Default'

variables:
  - group: 'Deployment-Secrets'

stages:
  - stage: NotifyStart
    displayName: 'Notify Build Started'
    jobs:
      - job: Telegram
        displayName: 'Send Telegram Notification'
        steps:
          - task: PowerShell@2
            displayName: 'Send Start Notification'
            inputs:
              targetType: 'inline'
              script: |
                $message = "üöÄ *KhulaFxAdmin Frontend Build Started*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdminNew (Angular)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                $message += "üîó [View](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }

  - stage: Build
    displayName: 'Build Angular Application'
    dependsOn: NotifyStart
    jobs:
      - job: BuildAngular
        displayName: 'Build Angular'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - task: PowerShell@2
            displayName: 'Set Node Memory Limit'
            inputs:
              targetType: 'inline'
              script: |
                $env:NODE_OPTIONS="--max-old-space-size=4096"
                Write-Host "Set Node memory limit to 4GB"

          - task: Npm@1
            displayName: 'npm install'
            inputs:
              command: 'install'
              workingDir: '.'

          - task: Npm@1
            displayName: 'npm build (production with base-href)'
            inputs:
              command: 'custom'
              workingDir: '.'
              customCommand: 'run build -- --configuration production --base-href=/secure-admin/'

          - task: PowerShell@2
            displayName: 'Create Configuration Files'
            inputs:
              targetType: 'inline'
              script: |
                $distFolder = Get-ChildItem -Path "$(System.DefaultWorkingDirectory)" -Filter "browser" -Recurse -Directory | Where-Object { $_.FullName -like "*dist*" } | Select-Object -First 1
                
                if (-not $distFolder) {
                  $distFolder = Get-ChildItem -Path "$(System.DefaultWorkingDirectory)/dist" -Directory | Select-Object -First 1
                }
                
                if ($distFolder) {
                  $distPath = $distFolder.FullName
                  Write-Host "Found dist folder: $distPath"
                } else {
                  Write-Error "Could not find dist folder"
                  exit 1
                }
                
                # Clean web.config - NO staticContent section to avoid conflicts
                $webConfig = @"
                <?xml version="1.0" encoding="utf-8"?>
                <configuration>
                  <system.webServer>
                    <rewrite>
                      <rules>
                        <rule name="Angular Routes" stopProcessing="true">
                          <match url=".*" />
                          <conditions logicalGrouping="MatchAll">
                            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                          </conditions>
                          <action type="Rewrite" url="index.html" />
                        </rule>
                      </rules>
                    </rewrite>
                  </system.webServer>
                </configuration>
                "@
                
                $robotsTxt = @"
                User-agent: *
                Disallow: /
                
                User-agent: Googlebot
                Disallow: /
                
                User-agent: Bingbot
                Disallow: /
                "@
                
                $webConfig | Out-File -FilePath "$distPath/web.config" -Encoding utf8 -Force
                $robotsTxt | Out-File -FilePath "$distPath/robots.txt" -Encoding utf8 -Force
                
                Write-Host "‚úÖ Clean web.config created" -ForegroundColor Green
                Write-Host "‚úÖ robots.txt created" -ForegroundColor Green

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)/dist'
              artifactName: 'frontend'

  - stage: Deploy
    displayName: 'Deploy to VPS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployFrontend
        displayName: 'Deploy to IIS'
        steps:
          - download: current
            artifact: frontend

          - task: PowerShell@2
            displayName: 'Find Browser Folder'
            inputs:
              targetType: 'inline'
              script: |
                $browserFolder = Get-ChildItem -Path "$(Pipeline.Workspace)/frontend" -Filter "browser" -Recurse -Directory | Select-Object -First 1
                
                if ($browserFolder) {
                  $deployPath = $browserFolder.FullName
                  Write-Host "Found browser folder: $deployPath"
                  Write-Host "##vso[task.setvariable variable=DeployPath]$deployPath"
                } else {
                  $firstDir = Get-ChildItem -Path "$(Pipeline.Workspace)/frontend" -Directory | Select-Object -First 1
                  if ($firstDir) {
                    $deployPath = $firstDir.FullName
                    Write-Host "Using folder: $deployPath"
                    Write-Host "##vso[task.setvariable variable=DeployPath]$deployPath"
                  } else {
                    Write-Error "Could not find deployment folder"
                    exit 1
                  }
                }

          - task: PowerShell@2
            displayName: 'Stop App Pool'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Stopping app pool on VPS..." -ForegroundColor Yellow
                
                try {
                  Invoke-Command -ComputerName $(vpsServer) -ScriptBlock {
                    Import-Module WebAdministration
                    $pool = Get-WebAppPool -Name "KhulaFxAppPool" -ErrorAction SilentlyContinue
                    if ($pool) {
                      Stop-WebAppPool -Name "KhulaFxAppPool" -ErrorAction Stop
                      Write-Host "‚úÖ App pool stopped" -ForegroundColor Green
                    } else {
                      Write-Host "‚ö†Ô∏è App pool not found, continuing..." -ForegroundColor Yellow
                    }
                  } -ErrorAction Stop
                  
                  Start-Sleep -Seconds 3
                }
                catch {
                  Write-Host "‚ö†Ô∏è Warning: Could not stop app pool: $($_.Exception.Message)" -ForegroundColor Yellow
                  Write-Host "Continuing with deployment..." -ForegroundColor Yellow
                }

          - task: PowerShell@2
            displayName: 'Deploy via Network Share'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Deploying Angular Frontend" -ForegroundColor Cyan
                Write-Host "========================================" -ForegroundColor Cyan
                
                $sourcePath = "$(DeployPath)"
                $destinationPath = "\\$(vpsServer)\c$\TRADERVPS\Sites\khulafx.com\secure-admin"
                
                Write-Host "Source: $sourcePath" -ForegroundColor White
                Write-Host "Destination: $destinationPath" -ForegroundColor White
                Write-Host ""
                
                try {
                  # Ensure directory exists
                  if (-not (Test-Path $destinationPath)) {
                    New-Item -ItemType Directory -Path $destinationPath -Force | Out-Null
                    Write-Host "‚úÖ Created directory" -ForegroundColor Green
                  }
                  
                  # Clean existing files (app pool is stopped, so files should be deletable)
                  Write-Host "Cleaning destination folder..." -ForegroundColor Yellow
                  Get-ChildItem -Path $destinationPath -Recurse -File -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
                  Get-ChildItem -Path $destinationPath -Recurse -Directory -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "‚úÖ Destination cleaned" -ForegroundColor Green
                  
                  # Copy all files
                  Write-Host "Copying files..." -ForegroundColor Yellow
                  Copy-Item -Path "$sourcePath\*" -Destination $destinationPath -Recurse -Force -ErrorAction Stop
                  Write-Host "‚úÖ Files copied" -ForegroundColor Green
                  
                  # Verify deployment
                  $deployedFiles = Get-ChildItem -Path $destinationPath -Recurse -File
                  Write-Host ""
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "‚úÖ Deployment Complete!" -ForegroundColor Green
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "Files deployed: $($deployedFiles.Count)" -ForegroundColor Cyan
                  Write-Host "Location: $destinationPath" -ForegroundColor Cyan
                  Write-Host ""
                  
                  # Verify key files
                  $indexExists = Test-Path "$destinationPath\index.html"
                  $webConfigExists = Test-Path "$destinationPath\web.config"
                  $robotsExists = Test-Path "$destinationPath\robots.txt"
                  
                  Write-Host "Key files check:" -ForegroundColor Yellow
                  Write-Host "  ‚úÖ index.html: $(if($indexExists){'Found'}else{'MISSING'})" -ForegroundColor $(if($indexExists){'Green'}else{'Red'})
                  Write-Host "  ‚úÖ web.config: $(if($webConfigExists){'Found'}else{'MISSING'})" -ForegroundColor $(if($webConfigExists){'Green'}else{'Red'})
                  Write-Host "  ‚úÖ robots.txt: $(if($robotsExists){'Found'}else{'MISSING'})" -ForegroundColor $(if($robotsExists){'Green'}else{'Red'})
                  
                  if (-not $indexExists) {
                    Write-Error "Critical: index.html is missing!"
                    exit 1
                  }
                }
                catch {
                  Write-Host "========================================" -ForegroundColor Red
                  Write-Host "‚ùå Deployment Failed!" -ForegroundColor Red
                  Write-Host "========================================" -ForegroundColor Red
                  Write-Error $_.Exception.Message
                  exit 1
                }

          - task: PowerShell@2
            displayName: 'Start App Pool'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Starting app pool on VPS..." -ForegroundColor Yellow
                
                try {
                  Invoke-Command -ComputerName $(vpsServer) -ScriptBlock {
                    Import-Module WebAdministration
                    $pool = Get-WebAppPool -Name "KhulaFxAppPool" -ErrorAction SilentlyContinue
                    if ($pool) {
                      Start-WebAppPool -Name "KhulaFxAppPool" -ErrorAction Stop
                      Write-Host "‚úÖ App pool started" -ForegroundColor Green
                    }
                  } -ErrorAction Stop
                  
                  Start-Sleep -Seconds 5
                }
                catch {
                  Write-Host "‚ùå Error starting app pool: $($_.Exception.Message)" -ForegroundColor Red
                  exit 1
                }

          - task: PowerShell@2
            displayName: 'Verify Website'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Waiting for IIS to update..." -ForegroundColor Yellow
                Start-Sleep -Seconds 8
                
                Write-Host "Testing website accessibility..." -ForegroundColor Yellow
                Write-Host ""
                
                $urls = @(
                  "https://khulafx.com/secure-admin",
                  "http://khulafx.com/secure-admin",
                  "http://$(vpsServer)/secure-admin"
                )
                
                $success = $false
                foreach ($url in $urls) {
                  try {
                    Write-Host "Testing: $url" -ForegroundColor Gray
                    $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 20 -ErrorAction Stop
                    Write-Host "  ‚úÖ Status: $($response.StatusCode)" -ForegroundColor Green
                    
                    # Check if it's actually Angular
                    if ($response.Content -like "*<app-root>*" -or $response.Content -like "*angular*") {
                      Write-Host "  ‚úÖ Angular app detected" -ForegroundColor Green
                    }
                    
                    $success = $true
                    break
                  }
                  catch {
                    Write-Host "  ‚ö†Ô∏è $($_.Exception.Message)" -ForegroundColor Yellow
                  }
                }
                
                Write-Host ""
                if ($success) {
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "‚úÖ Website is Live and Accessible!" -ForegroundColor Green
                  Write-Host "========================================" -ForegroundColor Green
                } else {
                  Write-Warning "Website not accessible yet via HTTP"
                  Write-Host "Files are deployed correctly to:" -ForegroundColor Cyan
                  Write-Host "  C:\TRADERVPS\Sites\khulafx.com\secure-admin\" -ForegroundColor White
                  Write-Host ""
                  Write-Host "If website still doesn't work, check:" -ForegroundColor Yellow
                  Write-Host "  1. IIS Application Pool is running" -ForegroundColor White
                  Write-Host "  2. Firewall allows port 80/443" -ForegroundColor White
                  Write-Host "  3. DNS points to VPS" -ForegroundColor White
                }

  - stage: NotifyComplete
    displayName: 'Notify Completion'
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: SendResult
        displayName: 'Send Telegram Result'
        steps:
          - task: PowerShell@2
            displayName: 'Send Notification'
            inputs:
              targetType: 'inline'
              script: |
                $success = "$(Agent.JobStatus)" -eq "Succeeded"
                $icon = if ($success) { "‚úÖ" } else { "‚ùå" }
                $status = if ($success) { "SUCCESS" } else { "FAILED" }
                
                $message = "$icon *KhulaFxAdmin Frontend Deploy $status!*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdminNew (Angular)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                
                if ($success) {
                  $message += "üåê *URL:* https://khulafx.com/secure-admin`n"
                }
                
                $duration = [math]::Round((New-TimeSpan -Start '$(System.PipelineStartTime)' -End (Get-Date)).TotalMinutes, 2)
                $message += "‚è±Ô∏è *Duration:* $duration minutes`n"
                $message += "üîó [View Logs](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }
