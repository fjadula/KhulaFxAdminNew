# Azure Pipeline for KhulaFxAdminNew (Frontend Angular)
# Repository: KhulaFxAdminNew
# Deploys to: http://108.181.161.170/secure-admin
# SAVE THIS FILE AS: azure-pipelines.yml in KhulaFxAdminNew repository root

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'Default'

variables:
  nodeVersion: '20.x'
  vpsServer: '108.181.161.170'
  deployUser: 'deployer'
  # Secrets in Azure DevOps Library:
  # - DEPLOY_PASSWORD
  # - TELEGRAM_BOT_TOKEN  
  # - TELEGRAM_CHAT_ID

stages:
  - stage: NotifyStart
    displayName: 'Notify Build Started'
    jobs:
      - job: Telegram
        displayName: 'Send Telegram Notification'
        steps:
          - task: PowerShell@2
            displayName: 'Send Start Notification'
            inputs:
              targetType: 'inline'
              script: |
                $message = "üöÄ *KhulaFxAdmin Frontend Build Started*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdminNew (Angular)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                $message += "üîó [View](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }

  - stage: Build
    displayName: 'Build Angular Application'
    dependsOn: NotifyStart
    jobs:
      - job: BuildAngular
        displayName: 'Build Angular'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Npm@1
            displayName: 'npm install'
            inputs:
              command: 'install'
              workingDir: '.'

          - task: Npm@1
            displayName: 'npm build (production)'
            inputs:
              command: 'custom'
              workingDir: '.'
              customCommand: 'run build -- --configuration production'

          - task: PowerShell@2
            displayName: 'Create Configuration Files'
            inputs:
              targetType: 'inline'
              script: |
                # Find the dist folder (Angular output)
                $distFolder = Get-ChildItem -Path "$(System.DefaultWorkingDirectory)" -Filter "browser" -Recurse -Directory | 
                              Where-Object { $_.FullName -like "*dist*" } | 
                              Select-Object -First 1
                
                if (-not $distFolder) {
                  $distFolder = Get-ChildItem -Path "$(System.DefaultWorkingDirectory)/dist" -Directory | Select-Object -First 1
                }
                
                if ($distFolder) {
                  $distPath = $distFolder.FullName
                  Write-Host "Found dist folder: $distPath"
                } else {
                  Write-Error "Could not find dist folder"
                  exit 1
                }
                
                # Create web.config for Angular routing
                $webConfig = @"
                <?xml version="1.0" encoding="utf-8"?>
                <configuration>
                  <system.webServer>
                    <rewrite>
                      <rules>
                        <rule name="Angular Routes" stopProcessing="true">
                          <match url=".*" />
                          <conditions logicalGrouping="MatchAll">
                            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                          </conditions>
                          <action type="Rewrite" url="/" />
                        </rule>
                      </rules>
                    </rewrite>
                    <httpProtocol>
                      <customHeaders>
                        <add name="X-Frame-Options" value="SAMEORIGIN" />
                        <add name="X-Content-Type-Options" value="nosniff" />
                        <add name="X-XSS-Protection" value="1; mode=block" />
                        <add name="X-Robots-Tag" value="noindex, nofollow" />
                      </customHeaders>
                    </httpProtocol>
                    <staticContent>
                      <mimeMap fileExtension=".json" mimeType="application/json" />
                      <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
                      <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
                    </staticContent>
                  </system.webServer>
                </configuration>
                "@
                
                # Create robots.txt to block search engines
                $robotsTxt = @"
                User-agent: *
                Disallow: /
                
                User-agent: Googlebot
                Disallow: /
                
                User-agent: Bingbot
                Disallow: /
                
                User-agent: DuckDuckBot
                Disallow: /
                "@
                
                # Save files
                $webConfig | Out-File -FilePath "$distPath/web.config" -Encoding utf8
                $robotsTxt | Out-File -FilePath "$distPath/robots.txt" -Encoding utf8
                
                Write-Host "‚úÖ web.config created"
                Write-Host "‚úÖ robots.txt created"
                
                # Show what we're deploying
                Write-Host "`nFiles to deploy:"
                Get-ChildItem -Path $distPath | Select-Object Name, Length

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)/dist'
              artifactName: 'frontend'

  - stage: Deploy
    displayName: 'Deploy to VPS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployFrontend
        displayName: 'Deploy to IIS'
        environment: 'VPS-Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend

                - task: PowerShell@2
                  displayName: 'Find Browser Folder'
                  inputs:
                    targetType: 'inline'
                    script: |
                      # Find the actual browser folder in artifacts
                      $browserFolder = Get-ChildItem -Path "$(Pipeline.Workspace)/frontend" -Filter "browser" -Recurse -Directory | Select-Object -First 1
                      
                      if ($browserFolder) {
                        $deployPath = $browserFolder.FullName
                        Write-Host "Found browser folder: $deployPath"
                        Write-Host "##vso[task.setvariable variable=DeployPath]$deployPath"
                      } else {
                        # Fallback to first directory
                        $firstDir = Get-ChildItem -Path "$(Pipeline.Workspace)/frontend" -Directory | Select-Object -First 1
                        if ($firstDir) {
                          $deployPath = $firstDir.FullName
                          Write-Host "Using folder: $deployPath"
                          Write-Host "##vso[task.setvariable variable=DeployPath]$deployPath"
                        } else {
                          Write-Error "Could not find deployment folder"
                          exit 1
                        }
                      }

                - task: PowerShell@2
                  displayName: 'Deploy via Web Deploy'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "========================================" -ForegroundColor Cyan
                      Write-Host "Deploying Angular Frontend to VPS" -ForegroundColor Cyan
                      Write-Host "========================================" -ForegroundColor Cyan
                      
                      $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
                      
                      if (-not (Test-Path $msdeploy)) {
                        Write-Error "‚ùå Web Deploy not found"
                        exit 1
                      }
                      
                      $sourcePath = "$(DeployPath)"
                      Write-Host "Source: $sourcePath"
                      Write-Host "Target: $(vpsServer)/secure-admin"
                      Write-Host ""
                      
                      # Show files being deployed
                      Write-Host "Files to deploy:"
                      Get-ChildItem -Path $sourcePath | Select-Object Name
                      Write-Host ""
                      
                      try {
                        & $msdeploy `
                          -verb:sync `
                          -source:contentPath="$sourcePath" `
                          -dest:contentPath='Default Web Site/secure-admin',ComputerName="https://$(vpsServer):8172/MsDeploy.axd",UserName='$(deployUser)',Password='$(DEPLOY_PASSWORD)',AuthType='Basic' `
                          -allowUntrusted `
                          -verbose
                        
                        if ($LASTEXITCODE -ne 0) {
                          Write-Error "‚ùå Deployment failed with code: $LASTEXITCODE"
                          exit $LASTEXITCODE
                        }
                        
                        Write-Host ""
                        Write-Host "‚úÖ Frontend deployed successfully!" -ForegroundColor Green
                      }
                      catch {
                        Write-Error "‚ùå Deployment failed: $_"
                        exit 1
                      }

                - task: PowerShell@2
                  displayName: 'Verify Deployment'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Testing frontend..." -ForegroundColor Yellow
                      Start-Sleep -Seconds 10
                      
                      try {
                        $response = Invoke-WebRequest -Uri "http://$(vpsServer)/secure-admin" -UseBasicParsing -TimeoutSec 30
                        Write-Host "‚úÖ Frontend Status: $($response.StatusCode)" -ForegroundColor Green
                        
                        # Check for Angular index.html
                        if ($response.Content -like "*<app-root>*" -or $response.Content -like "*angular*") {
                          Write-Host "‚úÖ Angular app detected in response" -ForegroundColor Green
                        }
                      }
                      catch {
                        Write-Error "‚ùå Frontend test failed: $($_.Exception.Message)"
                        exit 1
                      }

  - stage: NotifyComplete
    displayName: 'Notify Completion'
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: SendResult
        displayName: 'Send Telegram Result'
        steps:
          - task: PowerShell@2
            displayName: 'Send Notification'
            inputs:
              targetType: 'inline'
              script: |
                $success = "$(Agent.JobStatus)" -eq "Succeeded"
                $icon = if ($success) { "‚úÖ" } else { "‚ùå" }
                $status = if ($success) { "SUCCESS" } else { "FAILED" }
                
                $message = "$icon *KhulaFxAdmin Frontend Deploy $status!*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdminNew (Angular)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                
                if ($success) {
                  $message += "üåê *URL:* http://$(vpsServer)/secure-admin`n"
                }
                
                $duration = [math]::Round((New-TimeSpan -Start '$(System.PipelineStartTime)' -End (Get-Date)).TotalMinutes, 2)
                $message += "‚è±Ô∏è *Duration:* $duration minutes`n"
                $message += "üîó [View Logs](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }
