trigger:
  branches:
    include:
      - master
      - main

resources:
  repositories:
    - repository: self
      type: github
      name: fjadula/KhulaFxAdminNew
      endpoint: github

pool:
  name: 'Default'

variables:
  - group: 'Deployment-Secrets'

stages:
  - stage: Build
    displayName: 'Build Angular'
    jobs:
      - job: BuildAngular
        displayName: 'Build Angular'
        steps:
          - checkout: self
            clean: true

          - task: PowerShell@2
            displayName: 'Verify package.json'
            inputs:
              targetType: 'inline'
              script: |
                $packagePath = "$(Build.SourcesDirectory)/package.json"
                Write-Host "Checking: $packagePath" -ForegroundColor Cyan
                if (Test-Path $packagePath) {
                  Write-Host "OK" -ForegroundColor Green
                } else {
                  Write-Host "NOT FOUND" -ForegroundColor Red
                  Get-ChildItem -Path "$(Build.SourcesDirectory)" -Force
                  exit 1
                }

          - task: NodeTool@0
            displayName: 'Install Node 20'
            inputs:
              versionSpec: '20.x'


          - task: Npm@1
            displayName: 'npm install'
            inputs:
              command: 'install'
              workingDir: '$(Build.SourcesDirectory)'

          - task: PowerShell@2
            displayName: 'Generate environment.prod.ts'
            inputs:
              targetType: 'inline'
              script: |
                $apiUrl = "$(apiUrl)"
                Write-Host "Generating environment with API: $apiUrl" -ForegroundColor Cyan
                
                $envContent = @"
export const environment = {
  production: true,
  apiUrl: '$apiUrl'
};
"@
                
                $envPath = "$(Build.SourcesDirectory)/src/environments/environment.prod.ts"
                $envDir = Split-Path -Path $envPath
                
                if (-not (Test-Path $envDir)) {
                  New-Item -ItemType Directory -Path $envDir -Force | Out-Null
                }
                
                $envContent | Out-File -FilePath $envPath -Encoding utf8 -Force
                Write-Host "OK" -ForegroundColor Green

          - task: Npm@1
            displayName: 'npm build'
            inputs:
              command: 'custom'
              workingDir: '$(Build.SourcesDirectory)'
              customCommand: 'run build -- --configuration production --base-href=/secure-admin/'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish'
            inputs:
              pathToPublish: '$(Build.SourcesDirectory)/dist'
              artifactName: 'frontend'

  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy to IIS'
        steps:
          - download: current
            artifact: frontend

          - task: PowerShell@2
            displayName: 'Deploy Files'
            inputs:
              targetType: 'inline'
              script: |
                $src = "$(Pipeline.Workspace)/frontend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\TRADERVPS\Sites\khulafx.com\secure-admin"
                Write-Host "Source: $src"
                Write-Host "Dest: $dst"
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "Copied: $_"
                }
                Write-Host "Done"
