trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildAngular
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: 20.x

          - task: Npm@1
            inputs:
              command: install

          - task: Npm@1
            inputs:
              command: custom
              customCommand: run build -- --configuration production --base-href=/secure-admin/

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: $(Build.SourcesDirectory)/dist
              artifactName: frontend

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - download: current
            artifact: frontend

          - task: PowerShell@2
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/frontend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\TRADERVPS\Sites\khulafx.com\secure-admin"
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force -ErrorAction SilentlyContinue
                }
