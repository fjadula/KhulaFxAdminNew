trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildBackend
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 8
            inputs:
              version: 8.x
              packageType: sdk

          - task: DotNetCoreCLI@2
            displayName: Restore NuGet packages
            inputs:
              command: restore
              projects: |
                $(Build.SourcesDirectory)/KhulaFxTradeMonitor/KhulaFxTradeMonitor.csproj
                $(Build.SourcesDirectory)/KhulaFxAdmin/KhulaFxAdmin.csproj

          - task: DotNetCoreCLI@2
            displayName: Build KhulaFxTradeMonitor
            inputs:
              command: build
              projects: $(Build.SourcesDirectory)/KhulaFxTradeMonitor/KhulaFxTradeMonitor.csproj
              arguments: --configuration Release --no-restore

          - task: DotNetCoreCLI@2
            displayName: Build KhulaFxAdmin
            inputs:
              command: build
              projects: $(Build.SourcesDirectory)/KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --no-restore

          - task: DotNetCoreCLI@2
            displayName: Publish KhulaFxAdmin
            inputs:
              command: publish
              projects: $(Build.SourcesDirectory)/KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --output $(Build.ArtifactStagingDirectory)

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifacts
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: backend

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: DeployBackend
        steps:
          - download: current
            artifact: backend

          - task: PowerShell@2
            displayName: Deploy to IIS
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/backend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\inetpub\wwwroot\khulafx.com\api"
                
                Write-Host "Source: $src" -ForegroundColor Cyan
                Write-Host "Destination: $dst" -ForegroundColor Cyan
                
                if (-not (Test-Path $src)) {
                  Write-Error "Source not found"
                  exit 1
                }
                
                if (-not (Test-Path $dst)) {
                  Write-Error "Destination not accessible"
                  exit 1
                }
                
                Write-Host "Clearing old files..." -ForegroundColor Yellow
                $items = Get-ChildItem -Path $dst -Force -ErrorAction Continue
                foreach ($item in $items) {
                  if ($item.Name -ne "web.config") {
                    Remove-Item -Path $item.FullName -Recurse -Force -ErrorAction SilentlyContinue
                  }
                }
                
                Write-Host "Copying new files..." -ForegroundColor Yellow
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  if ($_.PSIsContainer) {
                    Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force
                  } else {
                    Copy-Item -Path $_.FullName -Destination $dst -Force
                  }
                  Write-Host "  OK: $($_.Name)" -ForegroundColor Green
                }
                
                $deployed = Get-ChildItem -Path $dst -Recurse -File
                Write-Host "Files deployed: $($deployed.Count)" -ForegroundColor Cyan
                Write-Host "âœ… Deployment Complete" -ForegroundColor Green
